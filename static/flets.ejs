<%- contentFor('css') %>

<title>Flets</title>

<%- contentFor('js') %>

<script>

	$(function(){


		var secs = 0;
		var countdown = 60
		var countdownNumberEl = document.getElementById('countdown-number');
		var spinnerContainerEl = document.querySelector('.spinner-container')

		countdownNumberEl.textContent = countdown;
		var retrieve = function(){
			spinnerContainerEl.classList.remove('fadeOut')
			spinnerContainerEl.classList.add('fadeIn')

			$.ajax({
				url: '/panel/search',
				method:'post',
				dataType: 'json',
				data: { data : JSON.stringify({
						limit:null,
						find: {
							mercadopago: { $ne: null}
						}
					})
				},
				success: function(res){
					$('.items-container').html($.templates("#item").render(res)).promise().done(function() {
						spinnerContainerEl.classList.remove('fadeIn')
						spinnerContainerEl.classList.add('fadeOut')
						//document.title = '(' + preferencias + ') FletsPanel'
					})
				}
			})	
		}

		setInterval(function(){
			countdown = --countdown <= 0 ? 60 : countdown;
			if(countdown===0){
				retrieve()	
			} 	
			countdownNumberEl.textContent = countdown;
		},1000)

		retrieve()
	})


</script>


<%- contentFor('content') %>

<% include ./header %>

<h2>Preferencias</h2>

<div class="items-container"></div>

<div id="countdown">
  <div id="countdown-number"></div>
  <svg>
    <circle r="18" cx="20" cy="20"></circle>
  </svg>
</div>

<script id="item" type="text/x-jsrender">
{{if !count}}
	<h6>No hay fletes todavía. ¡Esperemos un poco mas!</h6>
{{else}}
	<div class="columns is-multiline">
	{{for results}}
		<div class="column is-4  has-background-light">
			<span class="has-text-info is-size-6 convert-date">{{:id}}</span><br>
			<span class="has-text-dark is-size-4">{{:datos.nombre}}</span><br>
			<a href="tel:{{:datos.telefono}}"><span class="has-text-dark is-size-6">{{:datos.telefono}}</span></a><br>
			<span class="has-text-dark is-size-3">{{:estimate.amount}} ARS</span><br>
			<span class="has-text-dark is-size-4">{{:ruta.distance.text}}</span>
			<span class="has-text-dark is-size-4">{{:ruta.duration.text}}</span><br>
			<span class="has-text-dark is-size-6">{{:ruta.from.formatted_address}}</span>&nbsp;
			<span class="fas fa-hand-point-right has-text-dark"></span>&nbsp;
			<span class="has-text-dark is-size-6">{{:ruta.to.formatted_address}}</span><br>
			{{if mercadopago}}
			<span class="has-text-warning is-size-5">{{:mercadopago.status}}</span>
			{{/if}}
		</div>
	{{/for}}
	</div>
{{/if}}
</script>